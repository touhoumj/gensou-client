From 1598bb5a895e69d8ac1714486a28dca0f511e06a Mon Sep 17 00:00:00 2001
From: Chinpo Nya <czen+github@honk.li>
Date: Mon, 16 Oct 2023 03:48:06 +0200
Subject: [PATCH 3/6] unlock game features

---
 S/SCENE/MULTI.LUA                 |  2 +
 S/SCENE/NETWORK.LUA               | 80 ++++++++++++++++---------------
 S/SCENE/OPTIONS/DIALOG_SERIAL.LUA |  8 ++--
 S/SCENE/TITLE.LUA                 |  3 ++
 S/STATS/SERIAL.LUA                |  4 +-
 5 files changed, 52 insertions(+), 45 deletions(-)

diff --git a/S/SCENE/MULTI.LUA b/S/SCENE/MULTI.LUA
index 6debfdb..62d8e70 100644
--- a/S/SCENE/MULTI.LUA
+++ b/S/SCENE/MULTI.LUA
@@ -56,6 +56,8 @@ function multi_OnStart()
 	Socket.mode = "default";
 	if(_TRIAL)then
 		NEXT_THREAD = "t_multi_lobby";
+	elseif(_UNLOCKED)then
+		NEXT_THREAD = "t_multi_lobby";
 	elseif(CONFIG:get("multi_agreement")==false)then
 		NEXT_THREAD = "t_multi_agreement";
 	else
diff --git a/S/SCENE/NETWORK.LUA b/S/SCENE/NETWORK.LUA
index 44b137d..c22697d 100644
--- a/S/SCENE/NETWORK.LUA
+++ b/S/SCENE/NETWORK.LUA
@@ -1,7 +1,7 @@
--- ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
--- addSceneã•ã‚Œã‚‹ã®ã§sceneã«ç½®ã„ã¦ã¿ãŸã€‚
--- ã‚¿ã‚¹ã‚¯ã¯åŸºæœ¬çš„ã«ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šã¨ã‚Šã™ã‚‹ã€‚
--- TASKã«ä¿å­˜ã™ã‚‹éš›ã«ã¯serializeæ¸ˆã¿ã®çŠ¶æ…‹ã§ä¿å­˜ã™ã‚‹
+-- ƒ^ƒXƒNŠÇ—ƒXƒNƒŠƒvƒg
+-- addScene‚³‚ê‚é‚Ì‚Åscene‚É’u‚¢‚Ä‚İ‚½B
+-- ƒ^ƒXƒN‚ÍŠî–{“I‚É‚Íƒe[ƒuƒ‹ƒf[ƒ^‚ğ‚â‚è‚Æ‚è‚·‚éB
+-- TASK‚É•Û‘¶‚·‚éÛ‚É‚ÍserializeÏ‚İ‚Ìó‘Ô‚Å•Û‘¶‚·‚é
 
 prequire("s/lib/socket.lua");
 
@@ -12,7 +12,7 @@ REPLAY_FORCE_RUNNING = false;
 
 
 function network_init()
-	-- ã¾ã SocketãŒç„¡ã„å ´åˆã®ã¿åˆæœŸåŒ–ã™ã‚‹
+	-- ‚Ü‚¾Socket‚ª–³‚¢ê‡‚Ì‚İ‰Šú‰»‚·‚é
 	Socket = TCPBASE:new();
 	Socket.host = SERVER_ADDRESS;
 	Socket.port = SERVER_PORT;
@@ -47,7 +47,7 @@ function network_OnStep()
 end
 
 function checkPackage(md5)
-	-- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
+	-- ƒpƒbƒP[ƒWƒtƒ@ƒCƒ‹‚Ìƒ`ƒFƒbƒN
 	return true, -1;
 end
 
@@ -79,7 +79,7 @@ function TaskUpdate()
 				};
 				local result, body = POSTSend(Socket, "/index.php", send);
 				if(result == 0 and #body > 0)then
-					-- leaveã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã™ã‚‹ã®ã§é›¢è„±å‡¦ç†ã‚’è¡Œã†
+					-- leave‚µ‚½ƒvƒŒƒCƒ„[‚ÌƒnƒbƒVƒ…‚ª‘¶İ‚·‚é‚Ì‚Å—£’Eˆ—‚ğs‚¤
 					for i,v in pairs(body)do
 						for index,seat in pairs(SEAT)do
 							if(seat.hash == v and seat.playertype ~= "cpu")then
@@ -119,7 +119,7 @@ function getTaskServer(tasknum)
 		-- _dm("getTaskServer : Socket.snum = "..tostring(Socket.snum));
 		-- _dm("getTaskServer : body[1] = "..tostring(body[1]));
 		if(tonumber(body[1]) == nil)then
-			-- æ•°å­—ã«ç½®æ›ã§ããªã‹ã£ãŸã®ã§ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹
+			-- ”š‚É’uŠ·‚Å‚«‚È‚©‚Á‚½‚Ì‚ÅƒGƒ‰[‚Æ‚·‚é
 			return false;
 		end
 		if(Socket.snum > tonumber(body[1]))then
@@ -134,7 +134,7 @@ function getTaskServer(tasknum)
 	end
 	
 	if( #(body) > 0 )then
-		-- æˆåŠŸã—ãŸã®ã§è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹ã€‚
+		-- ¬Œ÷‚µ‚½‚Ì‚Å‹L˜^‚ğ•Û‘¶‚·‚éB
 		while(#(body) > 0)do
 			v = table.remove(body, 1);
 			if(string.len(v) < 1)then
@@ -144,9 +144,9 @@ function getTaskServer(tasknum)
 			local f,t,n_index,n_body = string.find(v, "task:(%d-):(.*)");
 			local str = deserialize(n_body);
 			if(type(str) ~= "table")then
-				_dm("å£Šã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ getTaskServerï¼š"..tostring(v));
+				_dm("‰ó‚ê‚½ƒf[ƒ^—getTaskServerF"..tostring(v));
 			elseif(tonumber(str.roomnum) == tonumber(Socket.roomnum))then
-				_dm("æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ï¼ getTaskServer["..n_index.."]ï¼š"..tostring(n_body));
+				_dm("³‚µ‚¢ƒf[ƒ^—getTaskServer["..n_index.."]F"..tostring(n_body));
 				TASK[ tonumber(n_index) ] = tostring(n_body);
 				Socket.snum = n_index + 1;
 			end
@@ -167,41 +167,41 @@ end
 
 function sendTaskServer(taskdata, level)
 	if(bNetwork==false)then
-		return true, nil;	-- é€ä¿¡ã™ã‚‹å¿…è¦ãŒç„¡ã„ã®ã§true
+		return true, nil;	-- ‘—M‚·‚é•K—v‚ª–³‚¢‚Ì‚Åtrue
 	end
 	if(REPLAYMODE)then
-		--_dm("ãƒªãƒ—ãƒ¬ã‚¤ä¸­ãªã®ã§ç„¡è¦–");
-		return true, nil;	-- é€ä¿¡ã™ã‚‹å¿…è¦ãŒç„¡ã„ã®ã§true
+		--_dm("ƒŠƒvƒŒƒC’†‚È‚Ì‚Å–³‹");
+		return true, nil;	-- ‘—M‚·‚é•K—v‚ª–³‚¢‚Ì‚Åtrue
 	end
 	
 	if( type(taskdata) ~= "table" )then
-		-- å¼•æ•°é–“é•ã£ã¦ã‚‹
+		-- ˆø”ŠÔˆá‚Á‚Ä‚é
 		_dm("taskdata not table.");
 		return false, nil;
 	end
 	
-	-- å†å¸°ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
+	-- Ä‹A‚ÌƒJƒEƒ“ƒg‚ğæ“¾
 	if(level==nil)then
 		level = 0;
 		taskdata.tag = getUUID();
 	elseif(level > 5)then
 		_dm("sendTaskServer all failed.");
 		
-		-- ã‚¿ã‚¹ã‚¯ã‚’æ§‹ç¯‰ã—ãªãŠã—
+		-- ƒ^ƒXƒN‚ğ\’z‚µ‚È‚¨‚µ
 		taskRebuild();
 		level = 0;
-		--æ—¢ã«è‡ªåˆ†ã®æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯è¡Œã‚ãšã«æˆ»ã‚‹
+		--Šù‚É©•ª‚Ìî•ñ‚ª“o˜^‚³‚ê‚Ä‚¢‚½‚çƒf[ƒ^‘—M‚Ís‚í‚¸‚É–ß‚é
 		if(TASK[Socket.snum] ~= nil)then
 			local t = TASK[Socket.snum];
 			if(t.tag == taskdata.tag)then
-				-- UUIDãŒä¸€è‡´ã—ãŸã®ã§æŠœã‘ã‚‹
+				-- UUID‚ªˆê’v‚µ‚½‚Ì‚Å”²‚¯‚é
 				return true, Socket.snum;
 			end
 		end
 		
 	end
 	
-	-- ç®¡ç†ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹
+	-- ŠÇ——p‚Ìƒf[ƒ^‚ğ’Ç‰Á‚·‚é
 	local result, body, str;
 	-- taskdata.time = os.time();
 	taskdata.roomnum = Socket.roomnum;
@@ -223,11 +223,11 @@ function sendTaskServer(taskdata, level)
 
 	local retry = true;
 	if(result == 0)then
-		-- é€ä¿¡ã«æˆåŠŸã—ãŸ
+		-- ‘—M‚É¬Œ÷‚µ‚½
 		if(type(body) == "table")then
 			if(body[1] == "OK")then
 			elseif(body[1] == "TASK_REGISTED")then
-				-- æ—¢ã«IDãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã®ã§ä¸€åº¦ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¦TASKã‚’æ›´æ–°ã™ã‚‹
+				-- Šù‚ÉID‚ª“o˜^‚³‚ê‚Ä‚¢‚½‚Ì‚Åˆê“xƒf[ƒ^‚ğóM‚µ‚ÄTASK‚ğXV‚·‚é
 				_dm("task registed. TASK Rebuild start");
 			else
 				_dm("Unknown Error :"..tostring(table.concat(body)));
@@ -252,7 +252,7 @@ function sendTaskServer(taskdata, level)
 	end
 	
 	if(retry)then
-		-- é€ä¿¡ã«å¤±æ•—ã—ãŸ
+		-- ‘—M‚É¸”s‚µ‚½
 		_dm("sendServer "..level.." failed. Retry");
 		level = level + 1;
 		local r,i = sendTaskServer(taskdata, level);
@@ -263,8 +263,8 @@ function sendTaskServer(taskdata, level)
 	
 end
 
--- å¼•æ•°ï¼šæ¬²ã—ã„ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹, ç‰¹æ®Šå‘½ä»¤ç³»ã‚’è¿”ã™ã‹ã©ã†ã‹ï¼ˆDefault:nil è¿”ã•ãªã„ï¼‰
--- æˆ»å€¤ï¼šæŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ãƒ†ãƒ¼ãƒ–ãƒ«
+-- ˆø”F—~‚µ‚¢ƒ^ƒXƒN‚ÌƒCƒ“ƒfƒbƒNƒX, “Áê–½—ßŒn‚ğ•Ô‚·‚©‚Ç‚¤‚©iDefault:nil •Ô‚³‚È‚¢j
+-- –ß’lFw’è‚³‚ê‚½ƒ^ƒXƒN‚Ìƒe[ƒuƒ‹
 function getTask(index, special)
 	if( type(index) ~= "number" )then
 		return nil;
@@ -273,7 +273,7 @@ function getTask(index, special)
 		special = false;
 	end
 --[[
-	-- è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã§å…ˆã«èµ°ã‚‰ãªã„å ´åˆã€å°‘ãªã„æ•°ã§èª¿æŸ»ã™ã‚‹
+	-- ŠÏíƒ‚[ƒh‚Åæ‚É‘–‚ç‚È‚¢ê‡A­‚È‚¢”‚Å’²¸‚·‚é
 	if(REPLAYMODE and bNetwork and not REPLAY_FORCE_RUNNING)then
 		if( #(TASK)-10 < index )then
 			return nil;
@@ -285,7 +285,7 @@ function getTask(index, special)
 		--local f,t,n_index,n_body = string.find(TASK[index], "(%d-):(.*)");
 		local taskdata = deserialize(TASK[index]);
 		
-		-- æœ€å¾Œã«å®Ÿè¡Œã—ãŸæ™‚é–“ã‚’ä¿å­˜ã™ã‚‹
+		-- ÅŒã‚ÉÀs‚µ‚½ŠÔ‚ğ•Û‘¶‚·‚é
 		if(type(taskdata) ~= "table")then
 			return nil;
 		else
@@ -302,12 +302,12 @@ function sendTask(task_data)
 		return false;
 	end
 	if(REPLAYMODE)then
-		_dm("ãƒªãƒ—ãƒ¬ã‚¤ä¸­ãªã®ã§ç„¡è¦–");
+		_dm("ƒŠƒvƒŒƒC’†‚È‚Ì‚Å–³‹");
 		return;
 	end
 
 	if(type(task_data) ~= "table")then
-		_dm("ãƒ†ãƒ¼ãƒ–ãƒ«ã˜ã‚ƒãªã„ã®ã§ç„¡è¦–");
+		_dm("ƒe[ƒuƒ‹‚¶‚á‚È‚¢‚Ì‚Å–³‹");
 		return false;
 	end
 
@@ -325,7 +325,7 @@ function taskRebuild()
 		return false;
 	end
 	
-	-- å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãªãŠã™
+	-- ‘Sƒf[ƒ^‚ğæ“¾‚µ‚È‚¨‚·
 	local build = true;
 	local tasks = {};
 	local i=1;
@@ -340,7 +340,7 @@ function taskRebuild()
 				local f,t,n_index,n_body = string.find(v, "task:(%d-):(.*)");
 				local str = deserialize(n_body);
 				if(tonumber(str.roomnum) == tonumber(Socket.roomnum))then
-					_dm("æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ï¼ getTaskServer["..i.."]ï¼š"..tostring(n_body));
+					_dm("³‚µ‚¢ƒf[ƒ^—getTaskServer["..i.."]F"..tostring(n_body));
 					tasks[ tonumber(i) ] = tostring(n_body);
 					i = i + 1;
 					build = true;
@@ -349,7 +349,7 @@ function taskRebuild()
 		end
 	end
 	
-	-- æ¯”è¼ƒã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ•´é “ã•ã›ã¦ã„ã
+	-- ”äŠr‚µ‚Äƒf[ƒ^‚ğ³‚µ‚­®“Ú‚³‚¹‚Ä‚¢‚­
 	for i,v in pairs(tasks) do
 		Socket.snum = i;
 		if(TASK[i] ~= v)then
@@ -363,25 +363,26 @@ function taskRebuild()
 
 end
 
--- ã‚µãƒ¼ãƒã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
+-- ƒT[ƒo‚Éƒf[ƒ^‚ğ•Û‘¶‚·‚é
 function save_server()
 	if(_TRIAL)then  return 0;  end
+	if(_UNLOCKED) then return 0; end
 
 	if(SERIAL:get("registed") == false)then
 		return -1;
 	end
 	
-	-- æˆ¦ç¸¾ã¯ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹
+	-- íÑ‚Í‚±‚Ìƒ^ƒCƒ~ƒ“ƒO‚ÅƒRƒs[‚·‚é
 	local stable = clone_table_r(PERSONALDATA);
 	for p=1,2 do
-		-- é’å¤©äº•ã ã‘ã¯BigIntã§ç®¡ç†ã™ã‚‹
+		-- Â“Vˆä‚¾‚¯‚ÍBigInt‚ÅŠÇ—‚·‚é
 		stable[p].on["totalscore_b"] = PERSONALDATA[p].on["totalscore_b"]:ToString();
 		stable[p].off["totalscore_b"] = PERSONALDATA[p].off["totalscore_b"]:ToString();
 	end
 	local sdata = string.gsub(serialize( clone_table_r(stable) ), "\n", "");
 	local sdata_hash = md5string(sdata);
 
-	-- ã‚µãƒ¼ãƒã«æˆ¦ç¸¾ã‚’ä¿å­˜ã™ã‚‹
+	-- ƒT[ƒo‚ÉíÑ‚ğ•Û‘¶‚·‚é
 	local query = {
 		func = "save_personaldata";
 		lasttime = os.time();
@@ -398,19 +399,20 @@ function save_server()
 		end
 	end
 	
-	-- æˆ¦ç¸¾ä¿å­˜ã«å¤±æ•—
+	-- íÑ•Û‘¶‚É¸”s
 	return -1;
 end
 
 
 function load_server()
 	if(_TRIAL)then  return false;  end
+	if(_UNLOCKED)then  return false;  end
 	
 	if(SERIAL:get("registed") == false)then
 		return false;
 	end
 
-	-- ã‚µãƒ¼ãƒå´ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ç¾åœ¨ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒã™ã‚‹
+	-- ƒT[ƒo‘¤‚ÌƒZ[ƒuƒf[ƒ^‚ÆŒ»İ‚ÌƒZ[ƒuƒf[ƒ^‚ğ”äŠr‚·‚é
 	local isGetSaveData = false;
 	local result, body;
 	for i=1,5 do
@@ -444,7 +446,7 @@ function load_server()
 	end
 
 	for p=1,2 do
-		-- é’å¤©äº•ã ã‘ã¯BigIntã§ç®¡ç†ã™ã‚‹
+		-- Â“Vˆä‚¾‚¯‚ÍBigInt‚ÅŠÇ—‚·‚é
 		PERSONALDATA[p].on["totalscore_b"] = BigInt(sdata[p].on["totalscore_b"]);
 		PERSONALDATA[p].off["totalscore_b"] = BigInt(sdata[p].off["totalscore_b"]);
 	end
diff --git a/S/SCENE/OPTIONS/DIALOG_SERIAL.LUA b/S/SCENE/OPTIONS/DIALOG_SERIAL.LUA
index df755d2..dba9e4d 100644
--- a/S/SCENE/OPTIONS/DIALOG_SERIAL.LUA
+++ b/S/SCENE/OPTIONS/DIALOG_SERIAL.LUA
@@ -33,13 +33,13 @@ function serial_window_OnStart()
 	C.FormSerialInput.window = AGT.createWindow(0,-40,628,324,1,"Serial Key settings");
 	C.FormSerialInput.btCancel = AGT.createButton(417,216,150,36,13,"Cancel",serial_window_btCancel_Click);
 	C.FormSerialInput.btOK = AGT.createButton(257,216,150,36,12,"Register",serial_window_btOK_Click);
-	if(not _TRIAL)then
+	if(not _TRIAL or not _UNLOCKEd)then
 		C.FormSerialInput.btInitialize = AGT.createButton(50,216,142,36,1,"Reset",serial_window_btInitialize_Click);
 	end
 	C.FormSerialInput.tbPlayerName = AGT.createTextBox(180,97,291,23,16,_SERIAL_USERNAME,nil,serial_window_tbPlayerName_StartEdit,serial_window_tbPlayerName_EndEdit);
 	C.FormSerialInput.tbSerial = AGT.createTextBox(180,134,291,23,16,_SERIAL_NUMBER,nil,serial_window_tbSerial_StartEdit,serial_window_tbSerial_EndEdit);
 	if(_TRIAL)then				C.FormSerialInput.tbSerial.enabled = false; C.FormSerialInput.tbSerial.text = "Not required for the trial version.";
-	elseif(_SERIAL_FIXED)then	C.FormSerialInput.tbSerial.enabled = false; C.FormSerialInput.tbSerial.text = "Serial Key registered."; end
+	elseif(_SERIAL_FIXED or _UNLOCKED)then	C.FormSerialInput.tbSerial.enabled = false; C.FormSerialInput.tbSerial.text = "Serial Key registered."; end
 
 	C.FormSerialInput.btCancel.shortcut = _SHORTCUT_CANCEL;
 	C.FormSerialInput.btCancel.overlaygraphic = G.icons[3];
@@ -82,7 +82,7 @@ function serial_window_OnStep()
 			if(not _SERIAL_FIXED)then _SERIAL_NUMBER = C.FormSerialInput.tbSerial.text; end
 			
 			local code,popstr;
-			if(_TRIAL)then
+			if(_TRIAL or _UNLOCKED)then
 				code = 0;
 				SERIAL:set("name", _SERIAL_USERNAME);
 			else
@@ -118,7 +118,7 @@ function serial_window_OnStep()
 			end
 		elseif(_SERIAL_ANSWER < 0)then
 			playSound(S.cancel);
-			if(_TRIAL)then
+			if(_TRIAL or _UNLOCKED)then
 			elseif(not _SERIAL_FIXED)then
 				show_ingamepopupinfo("You will not be able to play online until you set a serial key.");
 				NEXT_SCENE = "title";
diff --git a/S/SCENE/TITLE.LUA b/S/SCENE/TITLE.LUA
index 04df597..4f222fa 100644
--- a/S/SCENE/TITLE.LUA
+++ b/S/SCENE/TITLE.LUA
@@ -338,6 +338,9 @@ function title_initializeComponent()
 	if(SERIAL:get("registed")==false)then
 		C.title[2].enabled = false;
 	end
+	if(_UNLOCKED)then
+		C.title[2].enabled = true;
+	end
 	for i=1,#C.title do
 		if(C.title[i].enabled)then
 			C.title[i].events.onhoverstart = title_menus_onhoverstart;
diff --git a/S/STATS/SERIAL.LUA b/S/STATS/SERIAL.LUA
index e4cebf9..747defc 100644
--- a/S/STATS/SERIAL.LUA
+++ b/S/STATS/SERIAL.LUA
@@ -8,7 +8,7 @@ SERIAL = CSVDATABASE:new("s/stats/serial.csv");
 SERIAL_FILENAME = "serial4.dat";
 
 function initSerial()
-	if(_TRIAL)then
+	if(_TRIAL or _UNLOCKED)then
 		SERIAL:set("pin", getUUID());
 		SERIAL:set("registed", true);
 	end
@@ -90,7 +90,7 @@ function isSerialValid()
 		return false, MESSAGES:get("SERIAL_ERORR_VALUE");
 	elseif(#SERIAL:get("pin") < 1)then
 		return false, MESSAGES:get("SERIAL_ERORR_VALUE");
-	elseif(_LOCAL or _TRIAL)then
+	elseif(_LOCAL or _TRIAL or _UNLOCKED)then
 		return true;
 	end
 
-- 
2.44.1

