From 73b57547b336cb19383d04c1cd68a490e138d4a4 Mon Sep 17 00:00:00 2001
From: Chinpo Nya <czen+github@honk.li>
Date: Mon, 16 Oct 2023 03:47:43 +0200
Subject: [PATCH 2/4] change server address

---
 S/DEFINE.LUA          |  3 ++
 S/LIB/UPDATECHECK.LUA | 12 +++----
 S/SCENE/NETWORK.LUA   | 84 +++++++++++++++++++++----------------------
 S/SCENE/TELOP.LUA     |  6 ++--
 4 files changed, 54 insertions(+), 51 deletions(-)

diff --git a/S/DEFINE.LUA b/S/DEFINE.LUA
index 3ed171c..95eab10 100644
--- a/S/DEFINE.LUA
+++ b/S/DEFINE.LUA
@@ -14,3 +14,6 @@ MAGIC_ADDSP = 5;		-- 
 _LOCAL = false;
 _TRIAL = false;
 
+_UNLOCKED = true;
+SERVER_ADDRESS = "localhost"
+SERVER_PORT = 5000
\ No newline at end of file
diff --git a/S/LIB/UPDATECHECK.LUA b/S/LIB/UPDATECHECK.LUA
index 00fb7eb..672374e 100644
--- a/S/LIB/UPDATECHECK.LUA
+++ b/S/LIB/UPDATECHECK.LUA
@@ -2,10 +2,10 @@
 -- ‹¤’Ê—˜—p‚ÌƒAƒbƒvƒf[ƒ^
 
 UPDATER_ENV = {
-	host = "updater.amatukami.com";
-	port = "80";
-	serverpath = "/thmj4n";
-	md5list = "/thmj4n.md5.txt";
+	host = SERVER_ADDRESS;
+	port = SERVER_PORT;
+	serverpath = "/updater/thmj4n";
+	md5list = "/updater/thmj4n.md5.txt";
 	filelist = {
 		-- XV‘ÎÛ‚ÌƒŠƒXƒg‚ğ‹Lq‚·‚é
 		-- { filename, reboot(boolean) }
@@ -26,11 +26,11 @@ UPDATER_ENV = {
 __DELETEFILE = {};
 
 if(_DEBUG)then
-	UPDATER_ENV.host = "updater.dev.amatukami.com";
+	UPDATER_ENV.host = SERVER_ADDRESS;
 end
 local fp = io.open ("debug.txt", "rb");
 if( fp~=nil )then
-	UPDATER_ENV.host = "updater.dev.amatukami.com";
+	UPDATER_ENV.host = SERVER_ADDRESS;
 	fp:close();
 end
 
diff --git a/S/SCENE/NETWORK.LUA b/S/SCENE/NETWORK.LUA
index 92b2c34..44b137d 100644
--- a/S/SCENE/NETWORK.LUA
+++ b/S/SCENE/NETWORK.LUA
@@ -1,7 +1,7 @@
--- ƒ^ƒXƒNŠÇ—ƒXƒNƒŠƒvƒg
--- addScene‚³‚ê‚é‚Ì‚Åscene‚É’u‚¢‚Ä‚İ‚½B
--- ƒ^ƒXƒN‚ÍŠî–{“I‚É‚Íƒe[ƒuƒ‹ƒf[ƒ^‚ğ‚â‚è‚Æ‚è‚·‚éB
--- TASK‚É•Û‘¶‚·‚éÛ‚É‚ÍserializeÏ‚İ‚Ìó‘Ô‚Å•Û‘¶‚·‚é
+-- ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
+-- addSceneã•ã‚Œã‚‹ã®ã§sceneã«ç½®ã„ã¦ã¿ãŸã€‚
+-- ã‚¿ã‚¹ã‚¯ã¯åŸºæœ¬çš„ã«ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šã¨ã‚Šã™ã‚‹ã€‚
+-- TASKã«ä¿å­˜ã™ã‚‹éš›ã«ã¯serializeæ¸ˆã¿ã®çŠ¶æ…‹ã§ä¿å­˜ã™ã‚‹
 
 prequire("s/lib/socket.lua");
 
@@ -12,12 +12,12 @@ REPLAY_FORCE_RUNNING = false;
 
 
 function network_init()
-	-- ‚Ü‚¾Socket‚ª–³‚¢ê‡‚Ì‚İ‰Šú‰»‚·‚é
+	-- ã¾ã SocketãŒç„¡ã„å ´åˆã®ã¿åˆæœŸåŒ–ã™ã‚‹
 	Socket = TCPBASE:new();
-	Socket.host = "thmj.amatukami.com";
-	Socket.port = 19001;
+	Socket.host = SERVER_ADDRESS;
+	Socket.port = SERVER_PORT;
 	if(_DEBUG)then
-		Socket.port = 19002;
+		Socket.port = 4000;
 	end
 	
 	if(CONFIG:get("use_udp"))then
@@ -47,7 +47,7 @@ function network_OnStep()
 end
 
 function checkPackage(md5)
-	-- ƒpƒbƒP[ƒWƒtƒ@ƒCƒ‹‚Ìƒ`ƒFƒbƒN
+	-- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
 	return true, -1;
 end
 
@@ -79,7 +79,7 @@ function TaskUpdate()
 				};
 				local result, body = POSTSend(Socket, "/index.php", send);
 				if(result == 0 and #body > 0)then
-					-- leave‚µ‚½ƒvƒŒƒCƒ„[‚ÌƒnƒbƒVƒ…‚ª‘¶İ‚·‚é‚Ì‚Å—£’Eˆ—‚ğs‚¤
+					-- leaveã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã™ã‚‹ã®ã§é›¢è„±å‡¦ç†ã‚’è¡Œã†
 					for i,v in pairs(body)do
 						for index,seat in pairs(SEAT)do
 							if(seat.hash == v and seat.playertype ~= "cpu")then
@@ -119,7 +119,7 @@ function getTaskServer(tasknum)
 		-- _dm("getTaskServer : Socket.snum = "..tostring(Socket.snum));
 		-- _dm("getTaskServer : body[1] = "..tostring(body[1]));
 		if(tonumber(body[1]) == nil)then
-			-- ”š‚É’uŠ·‚Å‚«‚È‚©‚Á‚½‚Ì‚ÅƒGƒ‰[‚Æ‚·‚é
+			-- æ•°å­—ã«ç½®æ›ã§ããªã‹ã£ãŸã®ã§ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹
 			return false;
 		end
 		if(Socket.snum > tonumber(body[1]))then
@@ -134,7 +134,7 @@ function getTaskServer(tasknum)
 	end
 	
 	if( #(body) > 0 )then
-		-- ¬Œ÷‚µ‚½‚Ì‚Å‹L˜^‚ğ•Û‘¶‚·‚éB
+		-- æˆåŠŸã—ãŸã®ã§è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹ã€‚
 		while(#(body) > 0)do
 			v = table.remove(body, 1);
 			if(string.len(v) < 1)then
@@ -144,9 +144,9 @@ function getTaskServer(tasknum)
 			local f,t,n_index,n_body = string.find(v, "task:(%d-):(.*)");
 			local str = deserialize(n_body);
 			if(type(str) ~= "table")then
-				_dm("‰ó‚ê‚½ƒf[ƒ^—getTaskServerF"..tostring(v));
+				_dm("å£Šã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ getTaskServerï¼š"..tostring(v));
 			elseif(tonumber(str.roomnum) == tonumber(Socket.roomnum))then
-				_dm("³‚µ‚¢ƒf[ƒ^—getTaskServer["..n_index.."]F"..tostring(n_body));
+				_dm("æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ï¼ getTaskServer["..n_index.."]ï¼š"..tostring(n_body));
 				TASK[ tonumber(n_index) ] = tostring(n_body);
 				Socket.snum = n_index + 1;
 			end
@@ -167,41 +167,41 @@ end
 
 function sendTaskServer(taskdata, level)
 	if(bNetwork==false)then
-		return true, nil;	-- ‘—M‚·‚é•K—v‚ª–³‚¢‚Ì‚Åtrue
+		return true, nil;	-- é€ä¿¡ã™ã‚‹å¿…è¦ãŒç„¡ã„ã®ã§true
 	end
 	if(REPLAYMODE)then
-		--_dm("ƒŠƒvƒŒƒC’†‚È‚Ì‚Å–³‹");
-		return true, nil;	-- ‘—M‚·‚é•K—v‚ª–³‚¢‚Ì‚Åtrue
+		--_dm("ãƒªãƒ—ãƒ¬ã‚¤ä¸­ãªã®ã§ç„¡è¦–");
+		return true, nil;	-- é€ä¿¡ã™ã‚‹å¿…è¦ãŒç„¡ã„ã®ã§true
 	end
 	
 	if( type(taskdata) ~= "table" )then
-		-- ˆø”ŠÔˆá‚Á‚Ä‚é
+		-- å¼•æ•°é–“é•ã£ã¦ã‚‹
 		_dm("taskdata not table.");
 		return false, nil;
 	end
 	
-	-- Ä‹A‚ÌƒJƒEƒ“ƒg‚ğæ“¾
+	-- å†å¸°ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
 	if(level==nil)then
 		level = 0;
 		taskdata.tag = getUUID();
 	elseif(level > 5)then
 		_dm("sendTaskServer all failed.");
 		
-		-- ƒ^ƒXƒN‚ğ\’z‚µ‚È‚¨‚µ
+		-- ã‚¿ã‚¹ã‚¯ã‚’æ§‹ç¯‰ã—ãªãŠã—
 		taskRebuild();
 		level = 0;
-		--Šù‚É©•ª‚Ìî•ñ‚ª“o˜^‚³‚ê‚Ä‚¢‚½‚çƒf[ƒ^‘—M‚Ís‚í‚¸‚É–ß‚é
+		--æ—¢ã«è‡ªåˆ†ã®æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯è¡Œã‚ãšã«æˆ»ã‚‹
 		if(TASK[Socket.snum] ~= nil)then
 			local t = TASK[Socket.snum];
 			if(t.tag == taskdata.tag)then
-				-- UUID‚ªˆê’v‚µ‚½‚Ì‚Å”²‚¯‚é
+				-- UUIDãŒä¸€è‡´ã—ãŸã®ã§æŠœã‘ã‚‹
 				return true, Socket.snum;
 			end
 		end
 		
 	end
 	
-	-- ŠÇ——p‚Ìƒf[ƒ^‚ğ’Ç‰Á‚·‚é
+	-- ç®¡ç†ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹
 	local result, body, str;
 	-- taskdata.time = os.time();
 	taskdata.roomnum = Socket.roomnum;
@@ -223,11 +223,11 @@ function sendTaskServer(taskdata, level)
 
 	local retry = true;
 	if(result == 0)then
-		-- ‘—M‚É¬Œ÷‚µ‚½
+		-- é€ä¿¡ã«æˆåŠŸã—ãŸ
 		if(type(body) == "table")then
 			if(body[1] == "OK")then
 			elseif(body[1] == "TASK_REGISTED")then
-				-- Šù‚ÉID‚ª“o˜^‚³‚ê‚Ä‚¢‚½‚Ì‚Åˆê“xƒf[ƒ^‚ğóM‚µ‚ÄTASK‚ğXV‚·‚é
+				-- æ—¢ã«IDãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã®ã§ä¸€åº¦ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¦TASKã‚’æ›´æ–°ã™ã‚‹
 				_dm("task registed. TASK Rebuild start");
 			else
 				_dm("Unknown Error :"..tostring(table.concat(body)));
@@ -252,7 +252,7 @@ function sendTaskServer(taskdata, level)
 	end
 	
 	if(retry)then
-		-- ‘—M‚É¸”s‚µ‚½
+		-- é€ä¿¡ã«å¤±æ•—ã—ãŸ
 		_dm("sendServer "..level.." failed. Retry");
 		level = level + 1;
 		local r,i = sendTaskServer(taskdata, level);
@@ -263,8 +263,8 @@ function sendTaskServer(taskdata, level)
 	
 end
 
--- ˆø”F—~‚µ‚¢ƒ^ƒXƒN‚ÌƒCƒ“ƒfƒbƒNƒX, “Áê–½—ßŒn‚ğ•Ô‚·‚©‚Ç‚¤‚©iDefault:nil •Ô‚³‚È‚¢j
--- –ß’lFw’è‚³‚ê‚½ƒ^ƒXƒN‚Ìƒe[ƒuƒ‹
+-- å¼•æ•°ï¼šæ¬²ã—ã„ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹, ç‰¹æ®Šå‘½ä»¤ç³»ã‚’è¿”ã™ã‹ã©ã†ã‹ï¼ˆDefault:nil è¿”ã•ãªã„ï¼‰
+-- æˆ»å€¤ï¼šæŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ãƒ†ãƒ¼ãƒ–ãƒ«
 function getTask(index, special)
 	if( type(index) ~= "number" )then
 		return nil;
@@ -273,7 +273,7 @@ function getTask(index, special)
 		special = false;
 	end
 --[[
-	-- ŠÏíƒ‚[ƒh‚Åæ‚É‘–‚ç‚È‚¢ê‡A­‚È‚¢”‚Å’²¸‚·‚é
+	-- è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã§å…ˆã«èµ°ã‚‰ãªã„å ´åˆã€å°‘ãªã„æ•°ã§èª¿æŸ»ã™ã‚‹
 	if(REPLAYMODE and bNetwork and not REPLAY_FORCE_RUNNING)then
 		if( #(TASK)-10 < index )then
 			return nil;
@@ -285,7 +285,7 @@ function getTask(index, special)
 		--local f,t,n_index,n_body = string.find(TASK[index], "(%d-):(.*)");
 		local taskdata = deserialize(TASK[index]);
 		
-		-- ÅŒã‚ÉÀs‚µ‚½ŠÔ‚ğ•Û‘¶‚·‚é
+		-- æœ€å¾Œã«å®Ÿè¡Œã—ãŸæ™‚é–“ã‚’ä¿å­˜ã™ã‚‹
 		if(type(taskdata) ~= "table")then
 			return nil;
 		else
@@ -302,12 +302,12 @@ function sendTask(task_data)
 		return false;
 	end
 	if(REPLAYMODE)then
-		_dm("ƒŠƒvƒŒƒC’†‚È‚Ì‚Å–³‹");
+		_dm("ãƒªãƒ—ãƒ¬ã‚¤ä¸­ãªã®ã§ç„¡è¦–");
 		return;
 	end
 
 	if(type(task_data) ~= "table")then
-		_dm("ƒe[ƒuƒ‹‚¶‚á‚È‚¢‚Ì‚Å–³‹");
+		_dm("ãƒ†ãƒ¼ãƒ–ãƒ«ã˜ã‚ƒãªã„ã®ã§ç„¡è¦–");
 		return false;
 	end
 
@@ -325,7 +325,7 @@ function taskRebuild()
 		return false;
 	end
 	
-	-- ‘Sƒf[ƒ^‚ğæ“¾‚µ‚È‚¨‚·
+	-- å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãªãŠã™
 	local build = true;
 	local tasks = {};
 	local i=1;
@@ -340,7 +340,7 @@ function taskRebuild()
 				local f,t,n_index,n_body = string.find(v, "task:(%d-):(.*)");
 				local str = deserialize(n_body);
 				if(tonumber(str.roomnum) == tonumber(Socket.roomnum))then
-					_dm("³‚µ‚¢ƒf[ƒ^—getTaskServer["..i.."]F"..tostring(n_body));
+					_dm("æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ï¼ getTaskServer["..i.."]ï¼š"..tostring(n_body));
 					tasks[ tonumber(i) ] = tostring(n_body);
 					i = i + 1;
 					build = true;
@@ -349,7 +349,7 @@ function taskRebuild()
 		end
 	end
 	
-	-- ”äŠr‚µ‚Äƒf[ƒ^‚ğ³‚µ‚­®“Ú‚³‚¹‚Ä‚¢‚­
+	-- æ¯”è¼ƒã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ•´é “ã•ã›ã¦ã„ã
 	for i,v in pairs(tasks) do
 		Socket.snum = i;
 		if(TASK[i] ~= v)then
@@ -363,7 +363,7 @@ function taskRebuild()
 
 end
 
--- ƒT[ƒo‚Éƒf[ƒ^‚ğ•Û‘¶‚·‚é
+-- ã‚µãƒ¼ãƒã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
 function save_server()
 	if(_TRIAL)then  return 0;  end
 
@@ -371,17 +371,17 @@ function save_server()
 		return -1;
 	end
 	
-	-- íÑ‚Í‚±‚Ìƒ^ƒCƒ~ƒ“ƒO‚ÅƒRƒs[‚·‚é
+	-- æˆ¦ç¸¾ã¯ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹
 	local stable = clone_table_r(PERSONALDATA);
 	for p=1,2 do
-		-- Â“Vˆä‚¾‚¯‚ÍBigInt‚ÅŠÇ—‚·‚é
+		-- é’å¤©äº•ã ã‘ã¯BigIntã§ç®¡ç†ã™ã‚‹
 		stable[p].on["totalscore_b"] = PERSONALDATA[p].on["totalscore_b"]:ToString();
 		stable[p].off["totalscore_b"] = PERSONALDATA[p].off["totalscore_b"]:ToString();
 	end
 	local sdata = string.gsub(serialize( clone_table_r(stable) ), "\n", "");
 	local sdata_hash = md5string(sdata);
 
-	-- ƒT[ƒo‚ÉíÑ‚ğ•Û‘¶‚·‚é
+	-- ã‚µãƒ¼ãƒã«æˆ¦ç¸¾ã‚’ä¿å­˜ã™ã‚‹
 	local query = {
 		func = "save_personaldata";
 		lasttime = os.time();
@@ -398,7 +398,7 @@ function save_server()
 		end
 	end
 	
-	-- íÑ•Û‘¶‚É¸”s
+	-- æˆ¦ç¸¾ä¿å­˜ã«å¤±æ•—
 	return -1;
 end
 
@@ -410,7 +410,7 @@ function load_server()
 		return false;
 	end
 
-	-- ƒT[ƒo‘¤‚ÌƒZ[ƒuƒf[ƒ^‚ÆŒ»İ‚ÌƒZ[ƒuƒf[ƒ^‚ğ”äŠr‚·‚é
+	-- ã‚µãƒ¼ãƒå´ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ç¾åœ¨ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒã™ã‚‹
 	local isGetSaveData = false;
 	local result, body;
 	for i=1,5 do
@@ -444,7 +444,7 @@ function load_server()
 	end
 
 	for p=1,2 do
-		-- Â“Vˆä‚¾‚¯‚ÍBigInt‚ÅŠÇ—‚·‚é
+		-- é’å¤©äº•ã ã‘ã¯BigIntã§ç®¡ç†ã™ã‚‹
 		PERSONALDATA[p].on["totalscore_b"] = BigInt(sdata[p].on["totalscore_b"]);
 		PERSONALDATA[p].off["totalscore_b"] = BigInt(sdata[p].off["totalscore_b"]);
 	end
diff --git a/S/SCENE/TELOP.LUA b/S/SCENE/TELOP.LUA
index 452db9e..a2c5477 100644
--- a/S/SCENE/TELOP.LUA
+++ b/S/SCENE/TELOP.LUA
@@ -277,11 +277,11 @@ function getTelopData()
 	-- Ú‘±
 	if (TELOP_SOCKET == nil)then
 		TELOP_SOCKET = TCPBASE:new();
-		TELOP_SOCKET.host = "updater.amatukami.com";
+		TELOP_SOCKET.host = SERVER_ADDRESS;
+		TELOP_SOCKET.port = SERVER_PORT;
 		if(_DEBUG)then
-			TELOP_SOCKET.host = "updater.dev.amatukami.com";
+			TELOP_SOCKET.host = SERVER_ADDRESS;
 		end
-		TELOP_SOCKET.port = 80;
 	end
 	
 	local res, body = POSTSend(TELOP_SOCKET, "/thmj4n/title.txt", nil, "GET", false);
-- 
2.44.1

